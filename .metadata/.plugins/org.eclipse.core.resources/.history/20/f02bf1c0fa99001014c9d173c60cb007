package Ejercicio_01;

import org.bson.Document;
import org.bson.conversions.Bson;

import com.mongodb.client.MongoClient;
import com.mongodb.client.MongoClients;
import com.mongodb.client.MongoCollection;
import com.mongodb.client.MongoCursor;
import com.mongodb.client.MongoDatabase;
import com.mongodb.client.model.Filters;

public class FiltrosBiblioteca {
	public static void main(String [] args) {
		Document doc = null;
		// Conexion al servidor
		MongoClient mongoCliente = MongoClients.create();
		// Conexion a la base de datos
		MongoDatabase dbBiblioteca= mongoCliente.getDatabase("Biblioteca");
		// Conexion a una coleccion en especifico
		MongoCollection colLibros = dbBiblioteca.getCollection("Libros");
		MongoCollection colPrestamos = dbBiblioteca.getCollection("Prestamos");
		MongoCollection colSocios = dbBiblioteca.getCollection("Socios");
		// Metodo que busca todos los registros find() | .iterator sirve para que la coleccion sea recorrible
		MongoCursor <Document> cursor;
		MongoCursor <Document> cursorLibros = colLibros.find().iterator();
		
		// Ejercicio 1: Obtener primer registro
		System.out.println("-- Primer libro --");
		doc = (Document) colLibros.find().first();
		System.out.println(doc.toJson());
		
		// Ejercicio 2: Obtener lista libros
		System.out.println("-- Lista de libros --");
		while (cursorLibros.hasNext())  {
			// Devuelve .bson
//			System.out.println(cursorLibros.next());
			// Devuelve .json
			System.out.println(cursorLibros.next().toJson());
		}
		cursorLibros = colLibros.find().iterator();
		
		// Ejercicio 3: Obtener lista de socios
		System.out.println("-- Lista de Socios --");
		MongoCursor <Document> cursorSocios = colSocios.find().iterator();
		
		while (cursorSocios.hasNext()) {
			System.out.println(cursorSocios.next().toJson());
			
		}
		cursorSocios = colSocios.find().iterator(); // Se reinicia
		
		// Ejercicio 4: Obtener nombre de los socios
		System.out.println("-- Nombre de los socios --");
		while (cursorSocios.hasNext()) {
			System.out.println("Nombre: " + cursorSocios.next().get("Nombre"));
			
		}
		
		// ----- FILTROS BSON -----
		Bson bsonFilter;
		// Buscar libro titulado "El Quijote"
		System.out.println("-- Buscar libro El Quijote --");
		bsonFilter = Filters.eq("titulo", "El Quijote");
		doc = (Document) colLibros.find(bsonFilter).first(); // Solo hay uno, entonces .first. SI hubiera mas, .iterator
		System.out.println("Titulo: " + doc.get("titulo"));
		System.out.println("Titulo: " + doc.get("autor"));
		
		// Mostrar los prestamos con 2 libros
		MongoCursor <Document> cursorPrestamos = colPrestamos.find().iterator();
		
		bsonFilter = Filters.size("libro", 2);
		cursorPrestamos = colPrestamos.find(bsonFilter).iterator();
		
		while (cursorPrestamos.hasNext()) {
			System.out.println(cursorPrestamos.next());
			
		}
		
		// Mostrar libros con isbn mayor a 45000
		System.out.println("-- Libros con isbn > 45000 --");
		bsonFilter = Filters.gt("ISBN", 45000);
		cursorLibros = colLibros.find(bsonFilter).iterator();
		
		while (cursorLibros.hasNext()) {
			System.out.println("Libro: " + cursorLibros.next().get("titulo"));
			
		}
		// Buscar libros de Follet
		System.out.println("-- Libros de Follet --");
		bsonFilter = Filters.eq("autor.apellido", "Follet"); // Creo el filtro
		cursorLibros = colLibros.find(bsonFilter).iterator(); // hago un cursor de todos las colecciones que cumplan el filtro
		while (cursorLibros.hasNext()) {
			System.out.println("Libro: " + cursorLibros.next().get("titulo"));
			
		}
		// Buscar los que han tenido prestado 456779
		System.out.println("-- Socios con libro 456779 prestado --");
		
		
		bsonFilter = Filters.eq("libro.ISBN","456779");
		cursorPrestamos = colPrestamos.find(bsonFilter).iterator();
		while (cursorPrestamos.hasNext()) {
			doc = (Document) cursorPrestamos.next().get("socio"); // Cogo el documento del socio
			System.out.println("Numero de socio: " + doc.get("num_socio")); // Saco el numero de socio
		}

		bsonFilter = Filters.eq("Num_socio", doc.get("num_socio"));
		
		cursorSocios = colSocios.find(bsonFilter).iterator();

		while (cursorSocios.hasNext()) {
			System.out.println("Nombre: " + cursorSocios.next().get("Nombre"));
		}
		
		// Libro de mas de 500 paginas y que son de la editorial Plaza&Janes
		System.out.println("Libros de +500 paginas y de la editorial Plaza&Janes");
		
		bsonFilter = Filters.and(Filters.eq("editorial","Plaza&Janes"), Filters.gt("páginas", 500));
		cursor = colLibros.find(bsonFilter).iterator();
		while (cursor.hasNext()) {
			doc = cursor.next();
			System.out.println("Libro: " + doc.get("titulo") + " " + doc.get("páginas"));
		}
		
	}
}
